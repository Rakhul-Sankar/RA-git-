<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Analyzer - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .analyzing { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .progress-bar { transition: width 0.3s ease; }
        .modal-enter { animation: modalIn 0.3s ease-out; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md shadow-xl border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-800">üìä Resume Analyzer</h1>
                <div class="flex items-center gap-4">
                    <a href="upload.html" class="px-4 py-2 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 transition-all">
                        ‚ûï Upload
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- Analysis Time Settings Panel -->
        <div class="bg-white rounded-3xl shadow-2xl p-8 mb-8 border border-white/50">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">‚öôÔ∏è Analysis Configuration</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500">Analysis Mode:</span>
                    <select id="analysisMode" onchange="storage.setAnalysisMode(this.value)" 
                            class="px-4 py-2 border-2 border-gray-200 rounded-xl font-semibold focus:border-purple-500 focus:outline-none">
                        <option value="simulated">üé≠ Simulated (Demo)</option>
                        <option value="api">üåê Real API</option>
                        <option value="instant">‚ö° Instant (Testing)</option>
                    </select>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Speed Selection -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-2xl">
                    <h3 class="font-bold text-gray-700 mb-4">‚è±Ô∏è Analysis Speed</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/50 transition-all">
                            <input type="radio" name="speed" value="instant" onchange="storage.setSpeed(this.value)" class="w-5 h-5">
                            <div>
                                <div class="font-semibold text-gray-800">‚ö° Instant</div>
                                <div class="text-xs text-gray-500">0.5 seconds - Testing only</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/50 transition-all">
                            <input type="radio" name="speed" value="fast" onchange="storage.setSpeed(this.value)" class="w-5 h-5">
                            <div>
                                <div class="font-semibold text-gray-800">üöÄ Fast</div>
                                <div class="text-xs text-gray-500">2 seconds - Quick scan</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/50 transition-all bg-white/50">
                            <input type="radio" name="speed" value="normal" onchange="storage.setSpeed(this.value)" class="w-5 h-5" checked>
                            <div>
                                <div class="font-semibold text-gray-800">üîÑ Normal</div>
                                <div class="text-xs text-gray-500">4 seconds - Balanced</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/50 transition-all">
                            <input type="radio" name="speed" value="thorough" onchange="storage.setSpeed(this.value)" class="w-5 h-5">
                            <div>
                                <div class="font-semibold text-gray-800">üî¨ Thorough</div>
                                <div class="text-xs text-gray-500">8 seconds - Deep analysis</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-xl hover:bg-white/50 transition-all">
                            <input type="radio" name="speed" value="realistic" onchange="storage.setSpeed(this.value)" class="w-5 h-5">
                            <div>
                                <div class="font-semibold text-gray-800">üéØ Realistic</div>
                                <div class="text-xs text-gray-500">15-30 seconds - Like real AI</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Custom Time -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-2xl">
                    <h3 class="font-bold text-gray-700 mb-4">üéõÔ∏è Custom Duration</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-2">Time per resume (seconds)</label>
                            <input type="range" id="customTime" min="0.5" max="60" step="0.5" value="4" 
                                   onchange="storage.setCustomTime(this.value)"
                                   class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0.5s</span>
                                <span id="customTimeDisplay" class="font-bold text-purple-600">4s</span>
                                <span>60s</span>
                            </div>
                        </div>
                        
                        <!-- Estimated Time Calculator -->
                        <div class="bg-white rounded-xl p-4 mt-4">
                            <div class="text-sm text-gray-600 mb-2">üìä Estimated Total Time</div>
                            <div class="flex items-end gap-2">
                                <span id="estimatedTime" class="text-3xl font-black text-purple-600">0s</span>
                                <span class="text-gray-500 text-sm mb-1">for <span id="pendingCountEst">0</span> pending</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Options -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-2xl">
                    <h3 class="font-bold text-gray-700 mb-4">üéØ Analysis Options</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="autoAnalyze" onchange="storage.toggleAutoAnalyze()" class="w-5 h-5 rounded">
                            <div>
                                <div class="font-semibold text-gray-800">Auto-Analyze</div>
                                <div class="text-xs text-gray-500">Analyze new uploads automatically</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="showProgress" checked onchange="storage.toggleProgress()" class="w-5 h-5 rounded">
                            <div>
                                <div class="font-semibold text-gray-800">Show Progress</div>
                                <div class="text-xs text-gray-500">Display analysis steps</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="notifyComplete" checked class="w-5 h-5 rounded">
                            <div>
                                <div class="font-semibold text-gray-800">Notifications</div>
                                <div class="text-xs text-gray-500">Alert when complete</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="parallelAnalysis" class="w-5 h-5 rounded">
                            <div>
                                <div class="font-semibold text-gray-800">Parallel Processing</div>
                                <div class="text-xs text-gray-500">Analyze multiple at once</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- API Configuration (shown when API mode selected) -->
            <div id="apiConfig" class="hidden mt-6 p-6 bg-gray-50 rounded-2xl">
                <h3 class="font-bold text-gray-700 mb-4">üåê API Configuration</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-2">API Endpoint</label>
                        <input type="text" id="apiEndpoint" placeholder="https://api.example.com/analyze" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-2">API Key</label>
                        <input type="password" id="apiKey" placeholder="Your API key" 
                               class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-3">
                    üí° Connect to OpenAI, Claude, or your custom resume analysis API
                </p>
            </div>
        </div>

        <!-- Analysis Queue Banner -->
        <div id="analysisQueueBanner" class="hidden bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl p-6 mb-8 shadow-xl">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl spinner">‚öôÔ∏è</div>
                    <div>
                        <h3 class="font-bold text-lg">Analysis in Progress</h3>
                        <p id="analysisStatus" class="text-white/80">Initializing...</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-center">
                        <div id="timeRemaining" class="text-2xl font-bold">--</div>
                        <div class="text-xs text-white/70">Time Remaining</div>
                    </div>
                    <div class="text-center">
                        <div id="currentProgress" class="text-2xl font-bold">0/0</div>
                        <div class="text-xs text-white/70">Progress</div>
                    </div>
                    <button onclick="storage.togglePause()" id="pauseBtn" class="px-4 py-2 bg-white/20 rounded-xl hover:bg-white/30 transition-all font-semibold">
                        ‚è∏Ô∏è Pause
                    </button>
                    <button onclick="storage.stopAnalysis()" class="px-4 py-2 bg-red-500/50 rounded-xl hover:bg-red-500 transition-all font-semibold">
                        ‚èπÔ∏è Stop
                    </button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4 bg-white/20 rounded-full h-4 overflow-hidden">
                <div id="progressBar" class="progress-bar bg-white h-full rounded-full flex items-center justify-end pr-2" style="width: 0%">
                    <span id="progressPercent" class="text-xs font-bold text-purple-600"></span>
                </div>
            </div>

            <!-- Current Step Display -->
            <div id="currentStepDisplay" class="mt-4 flex gap-2 flex-wrap">
                <!-- Dynamic analysis steps -->
            </div>
        </div>

        <!-- Stats -->
        <div class="grid md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white rounded-2xl p-5 shadow-xl cursor-pointer hover:shadow-2xl transition-all" onclick="storage.filterBy('all')">
                <div id="totalCount" class="text-3xl font-black text-blue-600">0</div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Total</div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-xl cursor-pointer hover:shadow-2xl transition-all" onclick="storage.filterBy('analyzed')">
                <div id="analyzedCount" class="text-3xl font-black text-green-600">0</div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Analyzed</div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-xl cursor-pointer hover:shadow-2xl transition-all" onclick="storage.filterBy('pending')">
                <div id="pendingCount" class="text-3xl font-black text-yellow-500">0</div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Pending</div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-xl cursor-pointer hover:shadow-2xl transition-all" onclick="storage.filterBy('processing')">
                <div id="processingCount" class="text-3xl font-black text-blue-500">0</div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Processing</div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-xl">
                <div id="avgScore" class="text-3xl font-black text-purple-600">--%</div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Avg Score</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-4 mb-8 flex-wrap">
            <button id="analyzeAllBtn" onclick="storage.analyzeAllPending()" 
                    class="px-8 py-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-bold rounded-2xl shadow-xl hover:shadow-2xl hover:scale-105 transition-all">
                ü§ñ Analyze All Pending
            </button>
            <button onclick="storage.addTestResumes(5)" 
                    class="px-6 py-4 bg-gray-600 text-white font-bold rounded-2xl shadow-xl hover:bg-gray-700 transition-all">
                ‚ûï Add 5 Test Resumes
            </button>
            <button onclick="storage.clearAll()" 
                    class="px-6 py-4 bg-red-500 text-white font-bold rounded-2xl shadow-xl hover:bg-red-600 transition-all">
                üóëÔ∏è Clear All
            </button>
        </div>

        <!-- Resume Grid -->
        <div id="resumeGrid" class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Dynamic content -->
        </div>
    </main>

    <!-- Analysis Detail Modal -->
    <div id="analysisModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden modal-enter">
            <div class="p-6 border-b flex items-center justify-between bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                <h2 id="modalTitle" class="text-xl font-bold">Analysis Results</h2>
                <button onclick="storage.closeModal()" class="text-2xl hover:scale-110 transition-transform">‚úï</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto max-h-[70vh]">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

<script>
window.storage = {
    key: "advancedResumes_v2",
    resumes: [],
    
    // ========== TIMING CONFIGURATION ==========
    analysisConfig: {
        mode: 'simulated',      // simulated | api | instant
        speed: 'normal',        // instant | fast | normal | thorough | realistic | custom
        customTimeSeconds: 4,   // Custom time in seconds
        showProgress: true,
        autoAnalyze: false,
        parallelProcessing: false,
        maxParallel: 3
    },

    // Speed presets in milliseconds
    speedPresets: {
        instant: 500,
        fast: 2000,
        normal: 4000,
        thorough: 8000,
        realistic: 20000  // 15-30 seconds range
    },

    // Analysis state
    analysisState: {
        isAnalyzing: false,
        isPaused: false,
        queue: [],
        currentIndex: 0,
        totalCount: 0,
        startTime: null,
        currentResumeId: null
    },

    // Current filter
    currentFilter: 'all',

    init() {
        this.loadConfig();
        this.load();
        this.bindEvents();
        this.updateUI();
        
        // Live update
        setInterval(() => {
            this.load();
            this.updateEstimatedTime();
        }, 1000);
    },

    // ========== CONFIGURATION ==========
    loadConfig() {
        try {
            const saved = localStorage.getItem('analysisConfig');
            if (saved) {
                this.analysisConfig = { ...this.analysisConfig, ...JSON.parse(saved) };
            }
        } catch(e) { console.error('Config load error:', e); }
        
        // Update UI with saved config
        setTimeout(() => {
            document.querySelector(`input[name="speed"][value="${this.analysisConfig.speed}"]`)?.click();
            document.getElementById('customTime').value = this.analysisConfig.customTimeSeconds;
            document.getElementById('customTimeDisplay').textContent = this.analysisConfig.customTimeSeconds + 's';
            document.getElementById('autoAnalyze').checked = this.analysisConfig.autoAnalyze;
            document.getElementById('analysisMode').value = this.analysisConfig.mode;
            this.toggleApiConfig();
        }, 100);
    },

    saveConfig() {
        localStorage.setItem('analysisConfig', JSON.stringify(this.analysisConfig));
    },

    setSpeed(speed) {
        this.analysisConfig.speed = speed;
        
        // Update custom time slider to match preset
        if (speed !== 'custom') {
            const time = this.speedPresets[speed] / 1000;
            document.getElementById('customTime').value = time;
            document.getElementById('customTimeDisplay').textContent = time + 's';
            this.analysisConfig.customTimeSeconds = time;
        }
        
        this.saveConfig();
        this.updateEstimatedTime();
        this.showToast(`‚è±Ô∏è Speed set to ${speed} (${this.getAnalysisDuration()/1000}s per resume)`, 'info');
    },

    setCustomTime(seconds) {
        this.analysisConfig.customTimeSeconds = parseFloat(seconds);
        this.analysisConfig.speed = 'custom';
        document.getElementById('customTimeDisplay').textContent = seconds + 's';
        
        // Uncheck all radio buttons
        document.querySelectorAll('input[name="speed"]').forEach(r => r.checked = false);
        
        this.saveConfig();
        this.updateEstimatedTime();
    },

    setAnalysisMode(mode) {
        this.analysisConfig.mode = mode;
        this.saveConfig();
        this.toggleApiConfig();
        
        const modeNames = { simulated: 'Simulated Demo', api: 'Real API', instant: 'Instant Testing' };
        this.showToast(`üîÑ Analysis mode: ${modeNames[mode]}`, 'info');
    },

    toggleApiConfig() {
        const apiConfig = document.getElementById('apiConfig');
        if (this.analysisConfig.mode === 'api') {
            apiConfig.classList.remove('hidden');
        } else {
            apiConfig.classList.add('hidden');
        }
    },

    toggleAutoAnalyze() {
        this.analysisConfig.autoAnalyze = document.getElementById('autoAnalyze').checked;
        this.saveConfig();
        this.showToast(this.analysisConfig.autoAnalyze ? 'ü§ñ Auto-analyze enabled' : 'ü§ñ Auto-analyze disabled', 'info');
    },

    toggleProgress() {
        this.analysisConfig.showProgress = document.getElementById('showProgress').checked;
        this.saveConfig();
    },

    // Get current analysis duration in milliseconds
    getAnalysisDuration() {
        if (this.analysisConfig.mode === 'instant') return 100;
        
        if (this.analysisConfig.speed === 'custom') {
            return this.analysisConfig.customTimeSeconds * 1000;
        }
        
        if (this.analysisConfig.speed === 'realistic') {
            // Random between 15-30 seconds
            return Math.floor(Math.random() * 15000) + 15000;
        }
        
        return this.speedPresets[this.analysisConfig.speed] || 4000;
    },

    updateEstimatedTime() {
        const pending = this.resumes.filter(r => r.status === 'pending').length;
        const timePerResume = this.getAnalysisDuration() / 1000;
        const totalSeconds = pending * timePerResume;
        
        document.getElementById('pendingCountEst').textContent = pending;
        
        if (totalSeconds < 60) {
            document.getElementById('estimatedTime').textContent = Math.round(totalSeconds) + 's';
        } else if (totalSeconds < 3600) {
            document.getElementById('estimatedTime').textContent = Math.round(totalSeconds / 60) + 'm ' + Math.round(totalSeconds % 60) + 's';
        } else {
            document.getElementById('estimatedTime').textContent = Math.round(totalSeconds / 3600) + 'h ' + Math.round((totalSeconds % 3600) / 60) + 'm';
        }
    },

    // ========== DATA OPERATIONS ==========
    normalizeResume(r) {
        if (!r || typeof r !== 'object') return null;
        return {
            id: r.id || crypto.randomUUID(),
            name: r.name || "Untitled Resume",
            date: r.date || new Date().toLocaleDateString("en-CA"),
            uploadedAt: r.uploadedAt || Date.now(),
            analyzedAt: r.analyzedAt || null,
            score: r.score ?? null,
            status: r.status || "pending",
            type: r.type || "PDF",
            favorite: r.favorite || false,
            tags: Array.isArray(r.tags) ? r.tags : [],
            analysisResults: r.analysisResults || null,
            analysisProgress: r.analysisProgress || 0
        };
    },

    load() {
        try {
            const saved = localStorage.getItem(this.key);
            this.resumes = (saved ? JSON.parse(saved) : [])
                .map(r => this.normalizeResume(r))
                .filter(r => r !== null);
        } catch(e) { 
            console.error("Load error:", e);
            this.resumes = []; 
        }
        this.updateStats();
        this.render();
    },

    save() {
        localStorage.setItem(this.key, JSON.stringify(this.resumes));
        this.updateStats();
        this.render();
    },

    addTestResumes(count = 5) {
        const names = [
            "John_Smith_Resume.pdf", "Sarah_Johnson_CV.pdf", "Mike_Williams_Resume.docx",
            "Emily_Brown_CV.pdf", "David_Jones_Resume.pdf", "Lisa_Garcia_CV.pdf",
            "James_Miller_Resume.pdf", "Jennifer_Davis_CV.docx", "Robert_Wilson_Resume.pdf",
            "Maria_Martinez_CV.pdf"
        ];
        
        for (let i = 0; i < count; i++) {
            const name = names[Math.floor(Math.random() * names.length)];
            this.resumes.unshift(this.normalizeResume({
                name: name.replace('.pdf', `_${Date.now()}.pdf`).replace('.docx', `_${Date.now()}.docx`),
                status: 'pending'
            }));
        }
        
        this.save();
        this.showToast(`‚ûï Added ${count} test resumes`, 'success');
        
        if (this.analysisConfig.autoAnalyze) {
            setTimeout(() => this.analyzeAllPending(), 500);
        }
    },

    clearAll() {
        if (confirm('Delete all resumes?')) {
            this.resumes = [];
            this.save();
            this.showToast('üóëÔ∏è All resumes cleared', 'warning');
        }
    },

    // ========== ANALYSIS ENGINE ==========
    async analyzeAllPending() {
        const pending = this.resumes.filter(r => r.status === 'pending');
        
        if (pending.length === 0) {
            this.showToast('No pending resumes to analyze', 'info');
            return;
        }

        this.analysisState = {
            isAnalyzing: true,
            isPaused: false,
            queue: pending.map(r => r.id),
            currentIndex: 0,
            totalCount: pending.length,
            startTime: Date.now(),
            currentResumeId: null
        };

        this.updateQueueBanner();
        this.showToast(`ü§ñ Starting analysis of ${pending.length} resume(s)...`, 'info');

        await this.processQueue();
    },

    async processQueue() {
        const state = this.analysisState;
        
        while (state.currentIndex < state.queue.length && state.isAnalyzing) {
            // Handle pause
            while (state.isPaused && state.isAnalyzing) {
                await this.delay(200);
            }
            
            if (!state.isAnalyzing) break;

            const resumeId = state.queue[state.currentIndex];
            state.currentResumeId = resumeId;
            
            await this.analyzeResume(resumeId);
            
            state.currentIndex++;
            this.updateQueueBanner();
        }

        // Complete
        this.analysisState.isAnalyzing = false;
        this.updateQueueBanner();
        
        if (state.currentIndex === state.totalCount) {
            this.showAnalysisComplete();
        }
    },

    async analyzeResume(id) {
        const resume = this.resumes.find(r => r.id === id);
        if (!resume || resume.status === 'analyzed') return;

        // Set to processing
        resume.status = 'processing';
        resume.analysisProgress = 0;
        this.save();

        const duration = this.getAnalysisDuration();
        const steps = this.getAnalysisSteps();
        const stepDuration = duration / steps.length;

        // Simulate step-by-step analysis
        for (let i = 0; i < steps.length; i++) {
            if (!this.analysisState.isAnalyzing) {
                resume.status = 'pending';
                resume.analysisProgress = 0;
                this.save();
                return;
            }

            while (this.analysisState.isPaused) {
                await this.delay(200);
            }

            // Update current step
            this.updateCurrentStep(steps[i], i + 1, steps.length);
            resume.analysisProgress = ((i + 1) / steps.length) * 100;
            this.save();

            await this.delay(stepDuration);
        }

        // Generate results
        const results = this.generateResults(resume);
        
        resume.status = 'analyzed';
        resume.score = results.overallScore;
        resume.analyzedAt = Date.now();
        resume.analysisResults = results;
        resume.analysisProgress = 100;
        
        this.save();

        if (document.getElementById('notifyComplete').checked) {
            this.showToast(`‚úÖ ${resume.name}: ${results.overallScore}%`, 'success');
        }
    },

    getAnalysisSteps() {
        return [
            { icon: 'üìÑ', name: 'Reading document' },
            { icon: 'üîç', name: 'Extracting text' },
            { icon: 'üìä', name: 'Analyzing structure' },
            { icon: 'üíº', name: 'Evaluating experience' },
            { icon: 'üéì', name: 'Checking education' },
            { icon: '‚ö°', name: 'Scanning skills' },
            { icon: 'üîë', name: 'Finding keywords' },
            { icon: 'üìù', name: 'Formatting check' },
            { icon: 'ü§ñ', name: 'AI scoring' },
            { icon: '‚úÖ', name: 'Generating report' }
        ];
    },

    updateCurrentStep(step, current, total) {
        if (!this.analysisConfig.showProgress) return;
        
        const container = document.getElementById('currentStepDisplay');
        container.innerHTML = `
            <div class="bg-white/20 px-4 py-2 rounded-full flex items-center gap-2">
                <span class="text-lg">${step.icon}</span>
                <span class="font-semibold">${step.name}</span>
                <span class="text-white/70">(${current}/${total})</span>
            </div>
        `;
        
        document.getElementById('analysisStatus').textContent = `${step.icon} ${step.name}...`;
    },

    generateResults(resume) {
        const technical = Math.floor(Math.random() * 30) + 65;
        const experience = Math.floor(Math.random() * 30) + 60;
        const education = Math.floor(Math.random() * 25) + 70;
        const formatting = Math.floor(Math.random() * 20) + 75;
        const keywords = Math.floor(Math.random() * 25) + 65;

        const overallScore = Math.round(
            technical * 0.25 + experience * 0.30 + education * 0.15 + 
            formatting * 0.15 + keywords * 0.15
        );

        return {
            overallScore,
            breakdown: { technical, experience, education, formatting, keywords },
            strengths: this.generateStrengths(technical, experience, formatting),
            improvements: this.generateImprovements(technical, experience, keywords),
            atsScore: formatting >= 75 ? 'High' : formatting >= 60 ? 'Medium' : 'Low',
            rank: overallScore >= 85 ? 'Top 10%' : overallScore >= 70 ? 'Top 30%' : 'Top 50%',
            analysisDate: new Date().toISOString(),
            duration: this.getAnalysisDuration()
        };
    },

    generateStrengths(tech, exp, format) {
        const strengths = [];
        if (tech >= 80) strengths.push('Strong technical skills presentation');
        if (exp >= 80) strengths.push('Well-documented work experience');
        if (format >= 80) strengths.push('Professional formatting');
        if (strengths.length === 0) strengths.push('Good foundational structure');
        return strengths;
    },

    generateImprovements(tech, exp, keywords) {
        const improvements = [];
        if (tech < 70) improvements.push('Add more technical details');
        if (exp < 70) improvements.push('Include quantifiable achievements');
        if (keywords < 70) improvements.push('Optimize for ATS keywords');
        if (improvements.length === 0) improvements.push('Minor formatting tweaks recommended');
        return improvements;
    },

    // ========== QUEUE MANAGEMENT ==========
    updateQueueBanner() {
        const banner = document.getElementById('analysisQueueBanner');
        const state = this.analysisState;
        
        if (!state.isAnalyzing && this.resumes.filter(r => r.status === 'processing').length === 0) {
            banner.classList.add('hidden');
            return;
        }

        banner.classList.remove('hidden');
        
        // Progress
        const progress = state.totalCount > 0 ? (state.currentIndex / state.totalCount) * 100 : 0;
        document.getElementById('progressBar').style.width = `${progress}%`;
        document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
        document.getElementById('currentProgress').textContent = `${state.currentIndex}/${state.totalCount}`;
        
        // Time remaining
        const elapsed = Date.now() - state.startTime;
        const avgTimePerResume = state.currentIndex > 0 ? elapsed / state.currentIndex : this.getAnalysisDuration();
        const remaining = (state.totalCount - state.currentIndex) * avgTimePerResume;
        
        if (remaining < 60000) {
            document.getElementById('timeRemaining').textContent = Math.round(remaining / 1000) + 's';
        } else {
            document.getElementById('timeRemaining').textContent = Math.round(remaining / 60000) + 'm';
        }
        
        // Pause button
        document.getElementById('pauseBtn').innerHTML = state.isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
    },

    togglePause() {
        this.analysisState.isPaused = !this.analysisState.isPaused;
        this.updateQueueBanner();
        this.showToast(this.analysisState.isPaused ? '‚è∏Ô∏è Paused' : '‚ñ∂Ô∏è Resumed', 'info');
    },

    stopAnalysis() {
        this.analysisState.isAnalyzing = false;
        this.analysisState.isPaused = false;
        
        // Reset any processing resumes back to pending
        this.resumes.forEach(r => {
            if (r.status === 'processing') {
                r.status = 'pending';
                r.analysisProgress = 0;
            }
        });
        
        this.save();
        this.updateQueueBanner();
        this.showToast('‚èπÔ∏è Analysis stopped', 'warning');
    },

    showAnalysisComplete() {
        const analyzed = this.resumes.filter(r => r.status === 'analyzed');
        const avgScore = analyzed.length > 0 
            ? Math.round(analyzed.reduce((sum, r) => sum + (r.score || 0), 0) / analyzed.length)
            : 0;

        this.showToast(`üéâ Analysis complete! Average score: ${avgScore}%`, 'success');
    },

    // ========== UI HELPERS ==========
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },

    showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
        
        const toast = document.createElement('div');
        toast.className = `toast px-6 py-4 rounded-xl text-white font-semibold shadow-xl ${colors[type]}`;
        toast.textContent = message;
        container.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    },

    updateStats() {
        const analyzed = this.resumes.filter(r => r.status === 'analyzed');
        
        document.getElementById('totalCount').textContent = this.resumes.length;
        document.getElementById('analyzedCount').textContent = analyzed.length;
        document.getElementById('pendingCount').textContent = this.resumes.filter(r => r.status === 'pending').length;
        document.getElementById('processingCount').textContent = this.resumes.filter(r => r.status === 'processing').length;
        
        const avg = analyzed.length > 0 
            ? Math.round(analyzed.reduce((sum, r) => sum + (r.score || 0), 0) / analyzed.length)
            : 0;
        document.getElementById('avgScore').textContent = avg + '%';
        
        this.updateEstimatedTime();
        this.updateAnalyzeButton();
    },

    updateAnalyzeButton() {
        const pending = this.resumes.filter(r => r.status === 'pending').length;
        const btn = document.getElementById('analyzeAllBtn');
        
        if (pending > 0) {
            btn.innerHTML = `ü§ñ Analyze All (${pending})`;
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        } else {
            btn.innerHTML = '‚úÖ All Analyzed';
            btn.disabled = true;
            btn.classList.add('opacity-50');
        }
    },

    updateUI() {
        this.updateStats();
        this.updateEstimatedTime();
    },

    filterBy(filter) {
        this.currentFilter = filter;
        this.render();
    },

    render() {
        const box = document.getElementById('resumeGrid');
        let list = [...this.resumes];
        
        if (this.currentFilter !== 'all') {
            list = list.filter(r => r.status === this.currentFilter);
        }

        if (list.length === 0) {
            box.innerHTML = `
                <div class="col-span-full text-center py-16">
                    <div class="text-6xl mb-4">üì≠</div>
                    <h3 class="text-2xl font-bold text-gray-600">No Resumes</h3>
                    <p class="text-gray-500 mt-2">Add some test resumes to get started</p>
                    <button onclick="storage.addTestResumes(5)" class="mt-6 px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold hover:bg-purple-700 transition-all">
                        ‚ûï Add Test Resumes
                    </button>
                </div>
            `;
            return;
        }

        box.innerHTML = list.map(r => {
            const isProcessing = r.status === 'processing';
            let borderColor = 'border-gray-300';
            let scoreDisplay = '‚Äî';
            let scoreColor = 'bg-gray-400';

            if (r.status === 'analyzed' && r.score !== null) {
                scoreDisplay = r.score + '%';
                borderColor = 'border-green-500';
                scoreColor = r.score > 80 ? 'bg-green-500' : r.score > 60 ? 'bg-yellow-500' : 'bg-red-500';
            } else if (r.status === 'pending') {
                borderColor = 'border-yellow-400';
            } else if (r.status === 'processing') {
                borderColor = 'border-blue-500';
            }

            return `
                <div class="bg-white rounded-2xl shadow-xl p-5 border-l-4 ${borderColor} hover:shadow-2xl transition-all ${isProcessing ? 'analyzing' : ''}">
                    <h3 class="font-bold text-gray-800 truncate mb-1">${r.name}</h3>
                    <p class="text-xs text-gray-400 mb-3">üìÖ ${r.date}</p>
                    
                    ${isProcessing ? `
                        <div class="mb-3">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>Analyzing...</span>
                                <span>${Math.round(r.analysisProgress || 0)}%</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${r.analysisProgress || 0}%"></div>
                            </div>
                        </div>
                    ` : `
                        <div class="px-4 py-2 text-center rounded-full text-white font-bold ${scoreColor} mb-2">
                            ${r.status === 'pending' ? '‚è≥ Pending' : `Score: ${scoreDisplay}`}
                        </div>
                    `}
                    
                    <div class="flex gap-2 mt-3">
                        ${r.status === 'pending' ? `
                            <button onclick="storage.analyzeSingle('${r.id}')" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-xl text-xs font-semibold hover:bg-blue-700">
                                ü§ñ Analyze
                            </button>
                        ` : r.status === 'analyzed' ? `
                            <button onclick="storage.viewResults('${r.id}')" class="flex-1 px-3 py-2 bg-purple-600 text-white rounded-xl text-xs font-semibold hover:bg-purple-700">
                                üëÅÔ∏è View
                            </button>
                        ` : `
                            <button disabled class="flex-1 px-3 py-2 bg-gray-400 text-white rounded-xl text-xs font-semibold cursor-not-allowed">
                                <span class="spinner inline-block">‚öôÔ∏è</span> Processing
                            </button>
                        `}
                        <button onclick="storage.deleteResume('${r.id}')" class="px-3 py-2 bg-red-500 text-white rounded-xl text-xs font-semibold hover:bg-red-600">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    },

    async analyzeSingle(id) {
        const resume = this.resumes.find(r => r.id === id);
        if (!resume || resume.status !== 'pending') return;

        this.analysisState = {
            isAnalyzing: true,
            isPaused: false,
            queue: [id],
            currentIndex: 0,
            totalCount: 1,
            startTime: Date.now(),
            currentResumeId: id
        };

        this.updateQueueBanner();
        await this.analyzeResume(id);
        this.analysisState.isAnalyzing = false;
        this.analysisState.currentIndex = 1;
        this.updateQueueBanner();
    },

    viewResults(id) {
        const resume = this.resumes.find(r => r.id === id);
        if (!resume || !resume.analysisResults) return;

        const r = resume.analysisResults;
        const scoreColor = resume.score > 80 ? 'text-green-600' : resume.score > 60 ? 'text-yellow-600' : 'text-red-600';

        document.getElementById('modalTitle').textContent = resume.name;
        document.getElementById('modalContent').innerHTML = `
            <div class="text-center py-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl mb-6">
                <div class="text-6xl font-black ${scoreColor}">${resume.score}%</div>
                <div class="text-gray-600 mt-2">Overall Score</div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-4">
                <h4 class="font-bold text-gray-700 mb-3">üìä Breakdown</h4>
                ${Object.entries(r.breakdown).map(([key, val]) => `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="capitalize">${key}</span>
                            <span class="font-bold ${val >= 80 ? 'text-green-600' : val >= 60 ? 'text-yellow-600' : 'text-red-600'}">${val}%</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full ${val >= 80 ? 'bg-green-500' : val >= 60 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${val}%"></div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-green-50 p-4 rounded-xl">
                    <h4 class="font-bold text-green-700 mb-2">üí™ Strengths</h4>
                    <ul class="text-sm text-green-700 space-y-1">
                        ${r.strengths.map(s => `<li>‚úì ${s}</li>`).join('')}
                    </ul>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl">
                    <h4 class="font-bold text-yellow-700 mb-2">üìà Improve</h4>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        ${r.improvements.map(i => `<li>‚Ä¢ ${i}</li>`).join('')}
                    </ul>
                </div>
            </div>
            
            <div class="flex gap-4 text-center">
                <div class="flex-1 bg-blue-50 p-3 rounded-xl">
                    <div class="font-bold text-blue-600">${r.atsScore}</div>
                    <div class="text-xs text-gray-500">ATS Score</div>
                </div>
                <div class="flex-1 bg-purple-50 p-3 rounded-xl">
                    <div class="font-bold text-purple-600">${r.rank}</div>
                    <div class="text-xs text-gray-500">Ranking</div>
                </div>
                <div class="flex-1 bg-gray-50 p-3 rounded-xl">
                    <div class="font-bold text-gray-600">${(r.duration / 1000).toFixed(1)}s</div>
                    <div class="text-xs text-gray-500">Analysis Time</div>
                </div>
            </div>
        `;
        
        document.getElementById('analysisModal').classList.remove('hidden');
    },

    closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
    },

    deleteResume(id) {
        if (confirm('Delete this resume?')) {
            this.resumes = this.resumes.filter(r => r.id !== id);
            this.save();
            this.showToast('üóëÔ∏è Resume deleted', 'warning');
        }
    },

    bindEvents() {
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            
            if (e.key === 'a' || e.key === 'A') this.analyzeAllPending();
            if (e.key === 'p' || e.key === 'P') if (this.analysisState.isAnalyzing) this.togglePause();
            if (e.key === 'Escape') this.closeModal();
        });

        // Storage sync
        window.addEventListener('storage', (e) => {
            if (e.key === this.key) this.load();
        });
    }
};

storage.init();
</script>

</body>
</html>
